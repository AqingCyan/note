# 我为业务封装了一个外呼SDK

在公司的业务中有一些场景有用到外呼通话的，目前采用的是**第三方外呼SDK + 私有化外呼服务 + 服务端研发的外呼中心**的模式，
初版外呼就这么颤颤巍巍的跑过了挺长时间。但随着一些配合业务的更新迭代，遇到了不得不解决的问题。

## 旧的外呼结构

先解释一下👆上面提到的模式中不同模块负责的是什么事情：

浏览器本身想要实现打电话的功能就需要封装WebRTC和一个通话服务联通，然后通过通话服务和运营商的联通，实现该能力。我们很难自己去实现这样的架构，
这其中涉及到了通话资源，运营商服务，前端的语音能力，通话的信令同步等很多难点。因此我们选择直接采买第三方通话服务商来帮助业务拥有打电话的能力。

- <span style="color: #00cc00">第三方外呼SDK：即就是前端实现麦克风录音，联通外呼服务的能力的代码包。</span>
- <span style="color: #00cc00">私有化外呼服务：为了数据的安全性，提供与运营商通话能力的外呼服务被部署在了我们内部机器上。</span>
- <span style="color: #00cc00">外呼中心：这是我们自己根据通话策略研发的一个资源分配服务，用来分配不同的坐席和号码资源，根据业务场景做一些特定的业务控制。</span>
- <span style="color: #00cc00">坐席：登录外呼的实际账号，可以理解成一个坐席对应一个可以打电话的位置，位置是固定的，具体数量取决于财力，买多少有多少。</span>

👨‍👩‍👦 那么这几者的关系可以简述为一个完整的外呼流程：

- 外呼动作开始，外呼中心分配一个坐席给用户。
- 用户登录该坐席到私有化的外呼服务中，指定被服务对象进行外呼，传入被服务对象的号码给外呼中心。
- 外呼中心分配主叫号码与策略给当前坐席（此时被分配的主叫号码就被锁住，不会再分配给别的坐席）。
- 进行呼叫动作，挂断后，解锁主叫号码。

![旧外呼流程](../assets/old-webcall.png)

> 图中提到的主叫号码其实一开始没有起到决定作用，一开始我们所用方案都采用的认证号与固话，无需特别指定主叫号码，直接调用SDK外呼方法，呼通后，用户的手机会显示企业名称或是北京上海的座机号码。

## 后来的迭代

刚刚提到的一个概念：号码资源。其实外呼中心分配的资源不仅有坐席号，还有号码。

号码资源：拨通电话后，被叫号码显示的号码，不同的外呼号码的接通概率是不一样的，当然成本也不一致。而这里的成本指的是外呼的限制，国家对外呼业务的管控十分严格，
不同主叫号码与被叫号码可拨打的次数都会被严格把控，在一个很低的次数。因此我们将主叫与被叫整理为号码资源，严格把控，以保证外呼系统稳定不违规。

### 迭代的目的

在很多接通场景下，外呼被接听的概率很低，主要有以下几方面的原因：

- 固话会被标记成骚扰电话。
- 认证号在某些地区会被运营商拦截，或是不显示认证内容，也会被误认为骚扰电话。
- 用户明确告知不需要提供服务，但可能还会被其他员工外呼打扰。
- 外呼服务商提供的服务出现问题。

### 造成的问题
